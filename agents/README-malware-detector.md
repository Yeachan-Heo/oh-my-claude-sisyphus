# Malware Detector Agent

**Model:** Opus (comprehensive analysis)
**File:** `agents/malware-detector.md`

## Overview

The `malware-detector` agent is a comprehensive threat detection specialist designed to identify malware, viruses, spyware, trojans, backdoors, cryptominers, ransomware, and other malicious code patterns in codebases.

## Capabilities

### Threat Categories Detected

| Category | Description | Severity |
|----------|-------------|----------|
| **Trojans & Backdoors** | Reverse shells, hidden remote access, eval injection | CRITICAL |
| **Data Exfiltration** | SSH key theft, credential harvesting, env var leaks | CRITICAL |
| **Ransomware** | Mass file encryption, ransom note creation | CRITICAL |
| **Spyware** | Keyloggers, clipboard monitoring, screen capture | HIGH |
| **Cryptominers** | Mining pool connections, WebAssembly crypto | HIGH |
| **Obfuscation** | Hex variables, packed JS, char code arrays | HIGH |
| **Privilege Escalation** | Sudoers modification, SetUID manipulation | HIGH |
| **Persistence** | Cron jobs, systemd services, registry keys | HIGH |
| **Supply Chain** | Typosquatting, malicious postinstall scripts | MEDIUM-HIGH |

### Tools Available

- `Read` - Read file contents for analysis
- `Grep` - Pattern search across codebase
- `Glob` - File discovery by pattern
- `Bash` - Run security scanning commands
- `WebSearch` - Research unknown threats

## Usage

### Via Slash Command
```
/oh-my-claudecode:malware-scan
```

### Via Natural Language
```
"scan this code for malware"
"check for viruses and backdoors"
"run a security scan for trojans"
"detect any spyware or keyloggers"
```

### Direct Agent Delegation
```
Use the malware-detector agent to scan the /src directory for threats
```

## Detection Patterns

### Critical Patterns (Immediate Action)

```javascript
// Reverse shell detection
spawn('sh'), spawn('bash'), exec('cmd')

// Eval injection
eval(fetch(url)), eval(Buffer.from(x, 'base64'))

// Credential theft
readFile('.ssh/id_rsa'), process.env.AWS_SECRET

// Ransomware
readdirSync + encrypt + writeFile('.locked')
```

### High Severity Patterns

```javascript
// Keylogger
addEventListener('keydown', sendToServer)

// Cryptominer
stratum+tcp://, coinhive, WebAssembly + hash

// Obfuscation
var _0x1a2b = [...], String.fromCharCode(...)

// Persistence
/etc/cron.d, systemctl enable, HKLM\Run
```

## Output Format

The agent produces a detailed markdown report:

```markdown
# Malware Scan Report

**Scanned:** /path/to/project
**Date:** 2026-01-25T12:00:00Z
**Risk Score:** 75/100 - HIGH

## Executive Summary
- Threats Detected: 5
- Critical Issues: 1
- High Issues: 3
- Medium Issues: 1
- Verdict: SUSPICIOUS

## Critical Threats (Immediate Action Required)

### Reverse Shell Pattern
**Type:** BACKDOOR
**Severity:** CRITICAL
**Location:** `src/utils/helper.js:45`
**Evidence:**
```js
spawn('bash', ['-c', command])
```

## Recommendations
1. Isolate affected code
2. Review git history
3. Audit dependencies
```

## Risk Scoring

| Score Range | Verdict | Action |
|-------------|---------|--------|
| 90-100 | INFECTED | Immediate isolation, do not deploy |
| 70-89 | SUSPICIOUS | Manual review required |
| 30-69 | LOW RISK | Monitor, review flagged items |
| 0-29 | CLEAN | No action required |

## Best Practices

1. **Run on external code** - Always scan before using third-party repositories
2. **Pre-deployment scans** - Scan before pushing to production
3. **Dependency audits** - Run after adding new npm packages
4. **Incident response** - Use when investigating suspicious behavior
5. **Regular audits** - Schedule periodic security scans

## Limitations

- **False positives** - Security tools, DevOps scripts may trigger alerts
- **Obfuscated code** - Heavily obfuscated malware may evade detection
- **Zero-day threats** - Novel patterns not in detection library
- **Binary analysis** - Cannot analyze compiled binaries

## Related Agents

- `malware-detector-low` - Quick scan variant (Haiku model)
- `security-reviewer` - General security vulnerability detection
- `code-reviewer` - Code quality and best practices

## Example Session

```
User: scan this repository for any malicious code

Agent: I'll perform a comprehensive malware scan of this repository.

[Searches for backdoor patterns]
[Checks for data exfiltration code]
[Analyzes dependencies for supply chain risks]
[Generates threat report]

# Malware Scan Report
**Risk Score:** 15/100 - CLEAN
**Verdict:** No malicious patterns detected

The codebase appears clean. Minor informational findings:
- 3 uses of child_process (legitimate build scripts)
- 2 base64 operations (image encoding)

Recommendation: No action required.
```
